{% extends "layout.html" %}

{% block title %}عرض الفواتير{% endblock %}

{% block content %}
<main class="flex-1 p-8 space-y-8">
    <section id="supplier-list" class="space-y-8 fade-up">
      <div class="page-header">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-slate-300 via-slate-200 to-slate-400 bg-clip-text text-transparent mb-2">الموردين</h2>
            <p class="text-slate-400 text-base">اختر موردًا لعرض فواتيره ومدفوعاته</p>
          </div>
        </div>
      </div>
      <div id="suppliers-container" class="space-y-8">
          <p class="text-center text-slate-400">جاري تحميل الموردين...</p>
      </div>
    </section>
    
    <section id="supplier-invoices" class="hidden space-y-8">
      </section>
</main>
  
<div id="add-payment-modal" class="modal modal-is-hidden">
    <div class="modal-content">
      <h3 class="text-2xl font-bold mb-2">إضافة دفعة جديدة</h3>
      <p id="add-payment-supplier-name" class="mb-6 text-slate-400"></p>
      <div class="space-y-4">
        <div class="form-group"><label class="form-label">مبلغ الدفعة</label><input type="number" id="payment-amount" class="form-input" step="0.01" min="0" required></div>
        <div class="form-group"><label class="form-label">تاريخ الدفعة</label><input type="date" id="payment-date" class="form-input" required></div>
        <div class="form-group"><label class="form-label">ملاحظات</label><textarea id="payment-notes" class="form-input" rows="3"></textarea></div>
      </div>
      <div class="btn-group mt-8 justify-center">
        <button id="save-payment-btn" class="modern-btn success">حفظ</button>
        <button type="button" id="cancel-payment-btn" class="modern-btn">إلغاء</button>
      </div>
    </div>
</div>
  
<div id="delete-invoice-modal" class="modal modal-is-hidden">
     <div class="modal-content"><h3 class="text-xl font-bold">تأكيد الحذف</h3><p id="delete-invoice-text" class="my-4"></p><div class="btn-group"><button id="confirm-delete-invoice-btn" class="modern-btn danger">نعم، حذف</button><button id="cancel-delete-invoice-btn" class="modern-btn">إلغاء</button></div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- متغيرات لتخزين البيانات ---
    let suppliers = [];
    let invoices = [];
    let payments = [];
    let currentSupplierId = null;

    const elements = {
        supplierListSection: document.getElementById('supplier-list'),
        suppliersContainer: document.getElementById('suppliers-container'),
        supplierInvoicesSection: document.getElementById('supplier-invoices'),
        addPaymentModal: document.getElementById('add-payment-modal'),
        deleteInvoiceModal: document.getElementById('delete-invoice-modal'),
    };
    
    const formatCurrency = (amount) => new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR' }).format(amount || 0);

    function renderSuppliers() {
        elements.suppliersContainer.innerHTML = '';
        if (suppliers.length === 0) {
            elements.suppliersContainer.innerHTML = '<p class="text-center text-slate-400 glass-card">لا يوجد موردون لإضافتهم. ابدأ بإضافة فاتورة جديدة.</p>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

        suppliers.forEach(supplier => {
            const supplierInvoices = invoices.filter(i => i.supplier_id === supplier.id);
            const totalInvoiced = supplierInvoices.reduce((sum, i) => sum + i.total_amount, 0);
            const card = document.createElement('div');
            card.className = 'supplier-card cursor-pointer';
            card.innerHTML = `
                <h4 class="text-lg font-bold text-slate-200 mb-2">${supplier.name}</h4>
                <div class="text-sm text-slate-400">إجمالي الفواتير: ${formatCurrency(totalInvoiced)}</div>
            `;
            card.addEventListener('click', () => showInvoicesForSupplier(supplier.id));
            grid.appendChild(card);
        });
        elements.suppliersContainer.appendChild(grid);
    }

    function showInvoicesForSupplier(supplierId) {
        currentSupplierId = supplierId;
        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        elements.supplierListSection.classList.add('hidden');
        elements.supplierInvoicesSection.classList.remove('hidden');
        elements.supplierInvoicesSection.innerHTML = createSupplierDetailView(supplier);
        renderInvoicesAndPaymentsForCurrentSupplier();
        setupEventListenersForSupplierView();
    }
    
    function renderInvoicesAndPaymentsForCurrentSupplier() {
        if (!currentSupplierId) return;
        const supplierInvoices = invoices.filter(i => i.supplier_id === currentSupplierId);
        const supplierPayments = payments.filter(p => p.supplier_id === currentSupplierId);

        const invoicesTableBody = document.getElementById('invoices-table-body');
        const paymentsTableBody = document.getElementById('payments-table-body');
        
        invoicesTableBody.innerHTML = '';
        supplierInvoices.forEach(invoice => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${invoice.invoice_number}</td><td>${invoice.date}</td><td>${formatCurrency(invoice.total_amount)}</td><td>${invoice.notes || '-'}</td><td><button class="action-btn delete delete-invoice-btn" data-invoice-id="${invoice.id}" data-invoice-number="${invoice.invoice_number}">حذف</button></td>`;
            invoicesTableBody.appendChild(row);
        });

        paymentsTableBody.innerHTML = '';
        supplierPayments.forEach(payment => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${payment.date}</td><td class="font-bold text-green-300">${formatCurrency(payment.amount)}</td><td>${payment.notes || '-'}</td>`;
            paymentsTableBody.appendChild(row);
        });

        const totalInvoiced = supplierInvoices.reduce((sum, i) => sum + i.total_amount, 0);
        const totalPaid = supplierPayments.reduce((sum, p) => sum + p.amount, 0);
        document.getElementById('supplier-invoices-total').textContent = formatCurrency(totalInvoiced);
        document.getElementById('supplier-payments-total').textContent = formatCurrency(totalPaid);
        document.getElementById('supplier-outstanding-total').textContent = formatCurrency(totalInvoiced - totalPaid);
    }

    function createSupplierDetailView(supplier) {
        return `
            <div class="page-header"><h2 id="supplier-title" class="text-3xl font-bold ...">فواتير ومدفوعات: ${supplier.name}</h2><div class="btn-group"><button id="back-btn" class="modern-btn">العودة للموردين</button></div></div>
            <div class="payment-stats"><div class="payment-stat-card invoices"><div id="supplier-invoices-total" class="payment-stat-value invoices"></div><div class="payment-stat-label">إجمالي الفواتير</div></div><div class="payment-stat-card payments"><div id="supplier-payments-total" class="payment-stat-value payments"></div><div class="payment-stat-label">إجمالي المدفوعات</div></div><div class="payment-stat-card outstanding"><div id="supplier-outstanding-total" class="payment-stat-value outstanding"></div><div class="payment-stat-label">المبلغ المستحق</div></div></div>
            <div class="glass-card"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">إدارة المدفوعات</h3><button id="add-payment-btn" class="modern-btn success">إضافة دفعة</button></div><div class="modern-table-container"><table class="payment-table"><thead><tr><th>التاريخ</th><th>المبلغ</th><th>الملاحظات</th></tr></thead><tbody id="payments-table-body"></tbody></table></div></div>
            <div class="glass-card"><h3 class="text-2xl font-bold mb-6">سجل الفواتير</h3><div class="modern-table-container"><table id="invoices-table" class="modern-table"><thead><tr><th>رقم الفاتورة</th><th>التاريخ</th><th>الإجمالي</th><th>الملاحظات</th><th>العمليات</th></tr></thead><tbody id="invoices-table-body"></tbody></table></div></div>
        `;
    }

    function setupEventListenersForSupplierView() {
        document.getElementById('back-btn').addEventListener('click', showSupplierList);
        // ... ربط أحداث النوافذ المنبثقة هنا
    }

    function showSupplierList() {
        currentSupplierId = null;
        elements.supplierListSection.classList.remove('hidden');
        elements.supplierInvoicesSection.classList.add('hidden');
    }

    try {
        const response = await fetch('/api/data');
        const data = await response.json();
        suppliers = data.suppliers;
        invoices = data.invoices;
        payments = data.payments;
        renderSuppliers();
    } catch (error) {
        console.error('فشل في جلب البيانات:', error);
        elements.suppliersContainer.innerHTML = '<p class="text-red-500 text-center">خطأ في تحميل البيانات.</p>';
    }
});
</script>
{% endblock %}
