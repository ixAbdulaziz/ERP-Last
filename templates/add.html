{% extends "layout.html" %}

{% block title %}إضافة فاتورة جديدة{% endblock %}

{% block page_title %}إضافة فاتورة جديدة{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card card-md">
            <div class="card-body">
                <form action="{{ url_for('add_invoice') }}" method="post" enctype="multipart/form-data">
                    
                    <div class="mb-3" style="position: relative;">
                        <label class="form-label">اسم المورد (اكتب للبحث أو لإضافة مورد جديد)</label>
                        <input type="text" class="form-control" name="supplier_name" required autocomplete="off" id="supplier_name">
                        <div id="supplier-suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">رقم الفاتورة</label>
                            <input type="text" class="form-control" name="invoice_number" required>
                        </div>
                        <div class="col-md-6 mb-3">
                             <label class="form-label">نوع الفاتورة</label>
                             <input type="text" class="form-control" name="invoice_type" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">اسم الفئة</label>
                        <input type="text" class="form-control" name="category_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">تاريخ الفاتورة</label>
                        <input type="date" class="form-control" name="invoice_date" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">المبلغ (بدون ضريبة)</label>
                            <input type="number" class="form-control" id="amount_pre_tax" name="amount_pre_tax" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">الضريبة (0 إن لم يوجد)</label>
                            <input type="number" class="form-control" id="tax_amount" name="tax_amount" step="0.01" min="0" value="0" required>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center p-3 my-3 text-white bg-primary rounded shadow-sm">
                        <div class="lh-1">
                          <h1 class="h4 mb-0 text-white lh-1">الإجمالي: <span id="total-amount">0.00</span> ريال</h1>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">المرفقات</label>
                        <input class="form-control" type="file" name="attachment">
                    </div>

                    <div class="form-footer">
                      <button type="submit" class="btn btn-primary w-100">حفظ الفاتورة</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const amountInput = document.getElementById('amount_pre_tax');
    const taxInput = document.getElementById('tax_amount');
    const totalDisplay = document.getElementById('total-amount');

    function updateTotal() {
        const amount = parseFloat(amountInput.value) || 0;
        const tax = parseFloat(taxInput.value) || 0;
        totalDisplay.textContent = (amount + tax).toFixed(2);
    }
    amountInput.addEventListener('input', updateTotal);
    taxInput.addEventListener('input', updateTotal);
    updateTotal();

    const supplierInput = document.getElementById('supplier_name');
    const suggestionsBox = document.getElementById('supplier-suggestions');

    supplierInput.addEventListener('keyup', async function() {
        const query = supplierInput.value;
        suggestionsBox.innerHTML = '';
        if (query.length < 1) return;

        const response = await fetch(`/api/search_suppliers?q=${query}`);
        const suppliers = await response.json();

        suppliers.forEach(supplier => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = supplier.name;
            a.addEventListener('click', function(e) {
                e.preventDefault();
                supplierInput.value = this.textContent;
                suggestionsBox.innerHTML = '';
            });
            suggestionsBox.appendChild(a);
        });
    });
</script>
{% endblock %}
